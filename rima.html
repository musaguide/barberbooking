<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>RIMA â€“ LIFF Debug</title>
<link rel="preconnect" href="https://static.line-scdn.net">
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
  :root{--bg:#0b1220;--fg:#cfe6ff;--muted:#8fb8ff;}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;padding:16px;max-width:920px;margin:0 auto}
  h2{margin:8px 0 6px}
  .btn{display:block;width:100%;padding:12px 14px;margin:10px 0;border:1px solid #ddd;border-radius:12px;background:#fff;cursor:pointer;font-size:16px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  label{display:block;font-size:14px}
  input,select{width:100%;padding:10px;border:1px solid #ddd;border-radius:10px}
  #log{white-space:pre-wrap;background:var(--bg);color:var(--fg);border-radius:10px;padding:12px;min-height:180px}
  code{background:#f6f6f6;border:1px solid #eee;padding:2px 6px;border-radius:6px}
  .small{font-size:12px;color:#333}
  a{color:#0b57d0;text-decoration:none}
</style>
</head>
<body>
  <h2>RIMA â€“ LIFF Debugger</h2>
  <p class="small">
    Docs: <a href="https://developers.line.biz/en/docs/liff/" target="_blank" rel="noopener">https://developers.line.biz/en/docs/liff/</a> Â·
    Apps Script Web Apps: <a href="https://developers.google.com/apps-script/guides/web" target="_blank" rel="noopener">https://developers.google.com/apps-script/guides/web</a>
  </p>

  <div class="small">
    <div>LIFF ID: <code id="liffId">YOUR_LIFF_ID</code></div>
    <div>WEB_APP: <code id="webApp">YOUR_WEB_APP_URL</code></div>
  </div>

  <div class="row">
    <button class="btn" id="btnInit">Init LIFF</button>
    <button class="btn" id="btnProfile">Get Profile</button>
  </div>
  <div class="row">
    <button class="btn" id="btnPing">Ping Backend (GET /exec)</button>
    <button class="btn" id="btnSubmit">Submit Demo (POST submitRequest)</button>
  </div>
  <button class="btn" id="btnTrack">Track My Items</button>

  <h3>Request payload</h3>
  <div class="row">
    <label>Domain
      <select id="domain">
        <option>wingz.capital</option>
        <option>landsmilecrm</option>
        <option>introhub.me</option>
      </select>
    </label>
    <label>Request Type
      <select id="rtype">
        <option>loan</option>
        <option>land_service</option>
        <option>intro</option>
      </select>
    </label>
  </div>
  <div class="row">
    <label>Name <input id="name" placeholder="LIFF User"/></label>
    <label>Region <input id="region" placeholder="Phuket"/></label>
  </div>
  <div class="row">
    <label>Loan Amount <input id="amt" type="number" placeholder="3000000"/></label>
    <label>Loan Type <input id="ltype" placeholder="working_capital"/></label>
  </div>
  <div class="row">
    <label>Land Action <input id="laction" placeholder="fill / level / water_delivery"/></label>
    <label>Industry <input id="industry" placeholder="mining / hospitality"/></label>
  </div>
  <label>Notes <input id="notes" placeholder="anything else"/></label>

  <h3>Log</h3>
  <pre id="log">readyâ€¦</pre>

<script>
/** --------------------------
 *  Replace these placeholders
 * -------------------------- */
///const WEB_APP = 'YOUR_WEB_APP_URL';    // e.g. https://script.google.com/macros/s/AKfycb.../exec
const LIFF_ID = '2008221270-rY6odLMG';        // from LINE Developers
const WEB_APP = 'https://script.google.com/macros/s/AKfycbw_IGeNnM6PdpVAUfVgd11WuwEw4J4FK2Lxr7W7zRiEXT_UWRiQNlgt7pcyJLVvfwDV/exec';
///let userId = '';

/** State */
let userId = '';
let inited = false;

/** Utilities */
function out(){
  const el = document.getElementById('log');
  const msg = Array.from(arguments).map(a => typeof a==='string' ? a : JSON.stringify(a, null, 2)).join(' ');
  el.textContent += '\n' + msg;
  console.log.apply(console, arguments);
}
function v(id){ return document.getElementById(id).value.trim(); }

/** Global error traps */
window.onerror = (m, src, line, col, err) => out('window.onerror:', m, src+':'+line+':'+col, err && err.stack ? err.stack : '');
window.onunhandledrejection = (e) => out('unhandledrejection:', e && (e.reason || e));

/** Show placeholders */
document.getElementById('liffId').textContent = LIFF_ID;
document.getElementById('webApp').textContent = WEB_APP;

/** LIFF init + profile */
async function initLiff(){
  try{
    out('initLiff: starting with', LIFF_ID);
    await liff.init({ liffId: LIFF_ID });
    inited = true;
    out('LIFF: isInClient=', liff.isInClient(), 'isLoggedIn=', liff.isLoggedIn());
    if (!liff.isLoggedIn()){
      out('LIFF: not logged in â†’ calling liff.login()');
      liff.login(); // Will reload inside LINE
      return;
    }
    const prof = await liff.getProfile();
    userId = prof.userId || userId || 'DEBUG-USER';
    out('ðŸ‘¤ profile:', prof);
  }catch(e){
    out('initLiff error:', String(e));
  }
}
async function getProfile(){
  try{
    if (!inited) await initLiff();
    const prof = await liff.getProfile();
    userId = prof.userId || userId || 'DEBUG-USER';
    out('ðŸ‘¤ profile:', prof);
  }catch(e){ out('getProfile error:', e); }
}

/** Backend sanity pings */
async function pingBackend(){
  try{
    out('GET', WEB_APP);
    const res = await fetch(WEB_APP, { method:'GET' });
    out('status', res.status, res.statusText);
    const text = await res.text();
    out('raw', text);
    try{ out('json', JSON.parse(text)); }catch{ /* ignore */ }
  }catch(e){ out('ping error:', e); }
}

/** Submit demo request */
async function submitDemo(){
  try{
    if (!userId) userId = 'DEBUG-USER'; // desktop fallback
    const payload = {
      domain: v('domain'),
      request_type: v('rtype'),
      requester_name: v('name') || 'LIFF User',
      requester_line_user_id: userId,
      requester_contact: 'liff',
      region: v('region'),
      loan_amount: Number(v('amt')||0) || '',
      loan_type: v('ltype'),
      land_action: v('laction'),
      industry: v('industry'),
      notes: v('notes')
    };
    out('POST', WEB_APP, payload);
    const res = await fetch(WEB_APP, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ action:'submitRequest', payload })
    });
    out('status', res.status, res.statusText);
    const text = await res.text();
    out('raw', text);
    try{ out('json', JSON.parse(text)); }catch{ /* non-JSON */ }
  }catch(e){ out('submit error:', e); }
}

/** Track items */
async function trackItems(){
  try{
    if (!userId) userId = 'DEBUG-USER';
    out('POST track', WEB_APP, { userId });
    const res = await fetch(WEB_APP, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ action:'getMyItems', payload:{ userId } })
    });
    out('status', res.status, res.statusText);
    const text = await res.text();
    out('raw', text);
    try{ out('json', JSON.parse(text)); }catch{ /* non-JSON */ }
  }catch(e){ out('track error:', e); }
}

/** Wire buttons */
document.getElementById('btnInit').onclick = initLiff;
document.getElementById('btnProfile').onclick = getProfile;
document.getElementById('btnPing').onclick = pingBackend;
document.getElementById('btnSubmit').onclick = submitDemo;
document.getElementById('btnTrack').onclick = trackItems;

/** Auto-init in desktop (helps debugging outside LINE) */
try{ initLiff(); }catch(e){ out('auto init error:', e); }
</script>
</body>
</html>

